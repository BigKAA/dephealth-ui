# Grafana Dashboard Integration

**Language:** English | [Русский](./grafana-dashboards.ru.md)

## Overview

dephealth-ui provides direct links to Grafana dashboards from the topology graph. When a user clicks on a service node, dependency edge, or uses cascade analysis features, the UI generates URLs that open the corresponding Grafana dashboard with pre-filled variables.

At startup, the application validates dashboard availability via the Grafana API and hides links to dashboards that are not found.

## Dashboard Variable Requirements

Each dashboard type expects specific Grafana template variables:

| Dashboard | Config Key | Variables | Description |
|-----------|-----------|-----------|-------------|
| Service Status | `serviceStatus` | `var-service` | Single service health details |
| Link Status | `linkStatus` | `var-dependency`, `var-host`, `var-port` | Single dependency connection health |
| Cascade Overview | `cascadeOverview` | `var-namespace` | Cascade failure overview |
| Root Cause | `rootCause` | `var-service`, `var-namespace` | Root cause analysis |
| Connection Diagnostics | `connectionDiagnostics` | `var-namespace`, `var-service` | Connection diagnostics |
| Service List | `serviceList` | *(none)* | All services table |
| Services Status | `servicesStatus` | *(none)* | All services overview |
| Links Status | `linksStatus` | *(none)* | All links overview |

## URL Generation Examples

The backend generates Grafana URLs using the pattern `{baseUrl}/d/{uid}?{variables}`:

```
# Service Status
https://grafana.example.com/d/dephealth-service-status?var-service=my-service

# Link Status
https://grafana.example.com/d/dephealth-link-status?var-dependency=redis&var-host=redis.svc&var-port=6379

# Cascade Overview (frontend-generated)
https://grafana.example.com/d/dephealth-cascade-overview?var-namespace=production

# Root Cause (frontend-generated)
https://grafana.example.com/d/dephealth-root-cause?var-service=my-service&var-namespace=production
```

Service and link URLs are generated by the backend (`internal/topology/graph.go`). Cascade, root cause, and diagnostics URLs are generated by the frontend using UIDs from the `/api/v1/config` endpoint.

## Authentication Configuration

The application supports three authentication methods for the Grafana API, with the following priority:

### 1. Service Account Token (Recommended)

```yaml
grafana:
  baseUrl: "https://grafana.example.com"
  token: "glsa_xxxxxxxxxxxxxxxxxxxx"
```

Or via environment variable:
```bash
DEPHEALTH_GRAFANA_TOKEN=glsa_xxxxxxxxxxxxxxxxxxxx
```

### 2. Basic Authentication

```yaml
grafana:
  baseUrl: "https://grafana.example.com"
  username: "api-user"
  password: "api-password"
```

Or via environment variables:
```bash
DEPHEALTH_GRAFANA_USERNAME=api-user
DEPHEALTH_GRAFANA_PASSWORD=api-password
```

### 3. No Authentication

If neither token nor username is configured, requests are sent without authentication. This works when Grafana allows anonymous API access.

### Priority

When multiple credentials are configured: **token** > **basic auth** > **none**.

### Kubernetes Secret (Helm)

In Kubernetes deployments, credentials are typically stored in a Secret and injected via environment variables:

```bash
kubectl create secret generic grafana-creds \
  --from-literal=token="glsa_xxxxxxxxxxxxxxxxxxxx" \
  -n dephealth-ui
```

```yaml
# values.yaml
grafanaSecret:
  enabled: true
  secretName: grafana-creds
```

See the [Helm chart documentation](../deploy/helm/dephealth-ui/README.md) for details.

## Availability Checking

At application startup, the following checks are performed:

1. If `grafana.baseUrl` is empty — no checks, no dashboard links
2. `GET {baseUrl}/api/health` — verify Grafana is reachable
   - If unreachable: **all** dashboard UIDs are cleared, warning logged
3. For each configured (non-empty) dashboard UID: `GET {baseUrl}/api/dashboards/uid/{uid}`
   - If dashboard not found (404/403/5xx): UID is cleared, warning logged
   - If found (200): info logged

Cleared UIDs result in hidden links throughout the UI — both backend-generated URLs (service/link nodes) and frontend-generated URLs (cascade/diagnostics sidebar buttons).

## Minimum Grafana Version

- **Grafana 7.0+** — Dashboard UID API (`/api/dashboards/uid/{uid}`)
- **Grafana 9.0+** — Service Account Tokens (recommended authentication method)

## Security Recommendations

1. **Use Service Account Tokens** (Grafana 9+) instead of user credentials
2. Assign **Viewer** role — the checker only reads dashboard metadata
3. Store credentials in **Kubernetes Secrets**, not in config files
4. Use environment variable overrides (`DEPHEALTH_GRAFANA_TOKEN`) for CI/CD

## Pre-built Dashboards

The `dephealth-monitoring` Helm chart includes 8 pre-built dashboards provisioned via ConfigMaps. See the [Helm chart documentation](../deploy/helm/dephealth-ui/README.md#grafana-dashboards) for the full list and plugin requirements.
