{
  "__inputs": [],
  "__requires": [
    { "type": "grafana", "id": "grafana", "name": "Grafana", "version": "10.0.0" },
    { "type": "datasource", "id": "prometheus", "name": "Prometheus", "version": "1.0.0" }
  ],
  "annotations": { "list": [] },
  "description": "Диагностика статусов и ошибок соединений с зависимостями",
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 1,
  "id": null,
  "links": [
    {
      "asDropdown": false,
      "icon": "link",
      "includeVars": false,
      "keepTime": true,
      "tags": [],
      "targetBlank": false,
      "title": "Links Status",
      "type": "link",
      "url": "/d/dephealth-links-status/"
    },
    {
      "asDropdown": false,
      "icon": "apps",
      "includeVars": false,
      "keepTime": true,
      "tags": [],
      "targetBlank": false,
      "title": "Service List",
      "type": "link",
      "url": "/d/dephealth-service-list/"
    }
  ],
  "panels": [
    {
      "id": 1,
      "title": "Распределение статусов",
      "type": "piechart",
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "gridPos": { "h": 8, "w": 8, "x": 0, "y": 0 },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "fixed" },
          "mappings": []
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "ok" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "#4caf50" } }] },
          { "matcher": { "id": "byName", "options": "timeout" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "#ff9800" } }] },
          { "matcher": { "id": "byName", "options": "connection_error" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "#f44336" } }] },
          { "matcher": { "id": "byName", "options": "dns_error" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "#9c27b0" } }] },
          { "matcher": { "id": "byName", "options": "auth_error" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "#ffeb3b" } }] },
          { "matcher": { "id": "byName", "options": "tls_error" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "#b71c1c" } }] },
          { "matcher": { "id": "byName", "options": "unhealthy" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "#ff5722" } }] },
          { "matcher": { "id": "byName", "options": "error" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "#f44336" } }] }
        ]
      },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false },
        "pieType": "pie",
        "tooltip": { "mode": "single" },
        "legend": { "displayMode": "table", "placement": "right", "values": ["value", "percent"] }
      },
      "targets": [
        {
          "expr": "count by (status) (app_dependency_status{namespace=~\"$namespace\", job=~\"$service\", dependency=~\"$dependency\"} == 1)",
          "legendFormat": "{{status}}",
          "refId": "A",
          "instant": true,
          "range": false
        }
      ]
    },
    {
      "id": 2,
      "title": "Текущие ошибки",
      "type": "stat",
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "gridPos": { "h": 8, "w": 16, "x": 8, "y": 0 },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "fixed", "fixedColor": "red" },
          "mappings": [
            { "type": "special", "options": { "match": "null", "result": { "text": "N/A", "color": "gray" } } }
          ],
          "thresholds": {
            "mode": "absolute",
            "steps": [{ "color": "red", "value": null }]
          }
        },
        "overrides": []
      },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false },
        "orientation": "horizontal",
        "textMode": "name",
        "colorMode": "background",
        "graphMode": "none"
      },
      "targets": [
        {
          "expr": "max by (dependency, status) (app_dependency_status{namespace=~\"$namespace\", job=~\"$service\", dependency=~\"$dependency\", status=~\"$status\", status!=\"ok\"} == 1)",
          "legendFormat": "{{dependency}} ({{status}})",
          "refId": "A",
          "instant": true,
          "range": false
        }
      ]
    },
    {
      "id": 3,
      "title": "Статус (timeline)",
      "type": "state-timeline",
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 8 },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "lineWidth": 0,
            "fillOpacity": 80
          },
          "color": { "mode": "fixed", "fixedColor": "gray" },
          "thresholds": {
            "mode": "absolute",
            "steps": [{ "color": "gray", "value": null }]
          },
          "mappings": [
            { "type": "range", "options": { "from": -0.5, "to": 0.5, "result": { "text": "ok", "color": "#4caf50", "index": 0 } } },
            { "type": "range", "options": { "from": 0.5, "to": 1.5, "result": { "text": "timeout", "color": "#ff9800", "index": 1 } } },
            { "type": "range", "options": { "from": 1.5, "to": 2.5, "result": { "text": "conn_error", "color": "#f44336", "index": 2 } } },
            { "type": "range", "options": { "from": 2.5, "to": 3.5, "result": { "text": "dns_error", "color": "#9c27b0", "index": 3 } } },
            { "type": "range", "options": { "from": 3.5, "to": 4.5, "result": { "text": "auth_error", "color": "#ffeb3b", "index": 4 } } },
            { "type": "range", "options": { "from": 4.5, "to": 5.5, "result": { "text": "tls_error", "color": "#b71c1c", "index": 5 } } },
            { "type": "range", "options": { "from": 5.5, "to": 6.5, "result": { "text": "unhealthy", "color": "#ff5722", "index": 6 } } },
            { "type": "range", "options": { "from": 6.5, "to": 7.5, "result": { "text": "error", "color": "#f44336", "index": 7 } } }
          ]
        },
        "overrides": []
      },
      "options": {
        "showValue": "auto",
        "mergeValues": true,
        "rowHeight": 0.8,
        "alignValue": "center",
        "tooltip": { "mode": "single" },
        "legend": { "displayMode": "list", "placement": "bottom" }
      },
      "targets": [
        {
          "expr": "max by (job, dependency) (\n  (app_dependency_status{namespace=~\"$namespace\", job=~\"$service\", dependency=~\"$dependency\", status=\"ok\"} == 1) * 0\n  or (app_dependency_status{namespace=~\"$namespace\", job=~\"$service\", dependency=~\"$dependency\", status=\"timeout\"} == 1) * 1\n  or (app_dependency_status{namespace=~\"$namespace\", job=~\"$service\", dependency=~\"$dependency\", status=\"connection_error\"} == 1) * 2\n  or (app_dependency_status{namespace=~\"$namespace\", job=~\"$service\", dependency=~\"$dependency\", status=\"dns_error\"} == 1) * 3\n  or (app_dependency_status{namespace=~\"$namespace\", job=~\"$service\", dependency=~\"$dependency\", status=\"auth_error\"} == 1) * 4\n  or (app_dependency_status{namespace=~\"$namespace\", job=~\"$service\", dependency=~\"$dependency\", status=\"tls_error\"} == 1) * 5\n  or (app_dependency_status{namespace=~\"$namespace\", job=~\"$service\", dependency=~\"$dependency\", status=\"unhealthy\"} == 1) * 6\n  or (app_dependency_status{namespace=~\"$namespace\", job=~\"$service\", dependency=~\"$dependency\", status=\"error\"} == 1) * 7\n)",
          "legendFormat": "{{job}}/{{dependency}}",
          "refId": "A"
        }
      ]
    },
    {
      "id": 4,
      "title": "Таблица деталей",
      "type": "table",
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "gridPos": { "h": 10, "w": 24, "x": 0, "y": 16 },
      "targets": [
        {
          "expr": "max by (job, dependency, type, host, port, status) (app_dependency_status{namespace=~\"$namespace\", job=~\"$service\", dependency=~\"$dependency\", status!=\"ok\"} == 1)",
          "format": "table",
          "instant": true,
          "range": false,
          "refId": "A"
        },
        {
          "expr": "max by (job, dependency, type, host, port, detail) (app_dependency_status_detail{namespace=~\"$namespace\", job=~\"$service\", dependency=~\"$dependency\", detail!=\"ok\"} == 1)",
          "format": "table",
          "instant": true,
          "range": false,
          "refId": "B"
        }
      ],
      "transformations": [
        { "id": "merge", "options": {} },
        {
          "id": "organize",
          "options": {
            "excludeByName": {
              "Time": true,
              "__name__": true,
              "namespace": true,
              "instance": true,
              "critical": true,
              "name": true,
              "pod": true,
              "service": true,
              "Value #A": true,
              "Value #B": true
            },
            "indexByName": {
              "job": 0,
              "dependency": 1,
              "type": 2,
              "host": 3,
              "port": 4,
              "status": 5,
              "detail": 6
            },
            "renameByName": {
              "job": "Сервис",
              "dependency": "Зависимость",
              "type": "Тип",
              "host": "Хост",
              "port": "Порт",
              "status": "Статус",
              "detail": "Детали"
            }
          }
        },
        {
          "id": "sortBy",
          "options": {
            "fields": {},
            "sort": [{ "field": "Сервис", "desc": false }]
          }
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": {
            "align": "auto",
            "displayMode": "auto",
            "filterable": true
          }
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "Сервис" },
            "properties": [
              { "id": "custom.minWidth", "value": 180 },
              {
                "id": "links",
                "value": [
                  {
                    "title": "Статус сервиса \u2192",
                    "url": "/d/dephealth-service-status/?var-service=${__value.text}&${__url_time_range}",
                    "targetBlank": false
                  }
                ]
              }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Зависимость" },
            "properties": [
              { "id": "custom.minWidth", "value": 180 },
              {
                "id": "links",
                "value": [
                  {
                    "title": "Статус соединения \u2192",
                    "url": "/d/dephealth-link-status/?var-dependency=${__value.text}&var-host=${__data.fields[\"Хост\"]}&var-port=${__data.fields[\"Порт\"]}&${__url_time_range}",
                    "targetBlank": false
                  }
                ]
              }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Тип" },
            "properties": [
              { "id": "custom.minWidth", "value": 100 }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Хост" },
            "properties": [
              { "id": "custom.minWidth", "value": 220 }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Порт" },
            "properties": [
              { "id": "custom.minWidth", "value": 80 }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Статус" },
            "properties": [
              { "id": "custom.minWidth", "value": 130 },
              { "id": "custom.cellOptions", "value": { "type": "color-background", "mode": "basic" } },
              { "id": "color", "value": { "mode": "fixed", "fixedColor": "text" } },
              {
                "id": "mappings",
                "value": [
                  { "type": "value", "options": {
                    "ok": { "text": "ok", "color": "#4caf50" },
                    "timeout": { "text": "timeout", "color": "#ff9800" },
                    "connection_error": { "text": "conn_error", "color": "#f44336" },
                    "dns_error": { "text": "dns_error", "color": "#9c27b0" },
                    "auth_error": { "text": "auth_error", "color": "#ffeb3b" },
                    "tls_error": { "text": "tls_error", "color": "#b71c1c" },
                    "unhealthy": { "text": "unhealthy", "color": "#ff5722" },
                    "error": { "text": "error", "color": "#f44336" }
                  }}
                ]
              }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Детали" },
            "properties": [
              { "id": "custom.minWidth", "value": 150 }
            ]
          }
        ]
      },
      "options": {
        "showHeader": true,
        "cellHeight": "sm",
        "sortBy": [{ "displayName": "Статус", "desc": false }],
        "footer": { "show": false }
      }
    },
    {
      "id": 5,
      "title": "Ошибки по категориям",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 26 },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "fixed" },
          "decimals": 0,
          "min": 0,
          "custom": {
            "drawStyle": "bars",
            "lineWidth": 1,
            "fillOpacity": 80,
            "stacking": { "mode": "normal", "group": "A" },
            "showPoints": "never"
          }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "timeout" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "#ff9800" } }] },
          { "matcher": { "id": "byName", "options": "connection_error" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "#f44336" } }] },
          { "matcher": { "id": "byName", "options": "dns_error" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "#9c27b0" } }] },
          { "matcher": { "id": "byName", "options": "auth_error" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "#ffeb3b" } }] },
          { "matcher": { "id": "byName", "options": "tls_error" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "#b71c1c" } }] },
          { "matcher": { "id": "byName", "options": "unhealthy" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "#ff5722" } }] },
          { "matcher": { "id": "byName", "options": "error" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "#f44336" } }] }
        ]
      },
      "options": {
        "tooltip": { "mode": "multi", "sort": "desc" },
        "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["sum", "lastNotNull"] }
      },
      "targets": [
        {
          "expr": "count by (status) (app_dependency_status{namespace=~\"$namespace\", job=~\"$service\", dependency=~\"$dependency\", status!=\"ok\"} == 1)",
          "legendFormat": "{{status}}",
          "refId": "A"
        }
      ]
    }
  ],
  "refresh": "30s",
  "schemaVersion": 39,
  "tags": ["dephealth"],
  "templating": {
    "list": [
      {
        "name": "DS_PROMETHEUS",
        "type": "datasource",
        "query": "prometheus",
        "current": {},
        "hide": 0,
        "label": "Datasource"
      },
      {
        "name": "namespace",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
        "query": "label_values(app_dependency_status, namespace)",
        "refresh": 2,
        "includeAll": true,
        "allValue": ".*",
        "multi": true,
        "current": { "selected": true, "text": "All", "value": "$__all" },
        "hide": 0,
        "label": "Namespace"
      },
      {
        "name": "service",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
        "query": "label_values(app_dependency_status{namespace=~\"$namespace\"}, job)",
        "refresh": 2,
        "includeAll": true,
        "allValue": ".*",
        "multi": true,
        "current": { "selected": true, "text": "All", "value": "$__all" },
        "hide": 0,
        "label": "Сервис"
      },
      {
        "name": "dependency",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
        "query": "label_values(app_dependency_status{namespace=~\"$namespace\", job=~\"$service\"}, dependency)",
        "refresh": 2,
        "includeAll": true,
        "allValue": ".*",
        "multi": true,
        "current": { "selected": true, "text": "All", "value": "$__all" },
        "hide": 0,
        "label": "Зависимость"
      },
      {
        "name": "status",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
        "query": "label_values(app_dependency_status, status)",
        "refresh": 2,
        "includeAll": true,
        "allValue": ".*",
        "multi": true,
        "current": { "selected": true, "text": "All", "value": "$__all" },
        "hide": 0,
        "label": "Статус"
      }
    ]
  },
  "time": { "from": "now-1h", "to": "now" },
  "timepicker": {},
  "timezone": "",
  "title": "dephealth: Connection Diagnostics",
  "uid": "dephealth-connection-diagnostics",
  "version": 1
}
